name: DeepRVAT Pipeline tests
run-name: DeepRVAT Pipeline tests üß¨üß™üíªüßë‚Äçüî¨
on: [ push ]

jobs:
  # Training Pipeline
  Smoke-RunTraining:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-RunTraining
      pipeline_file: ./pipelines/run_training.snakefile

  Pipeline-Tests-RunTraining:
    needs: Smoke-RunTraining
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Run run_training pipeline
      pipeline_file: ./pipelines/run_training.snakefile
      dry_run: false

  # Association Testing Pretrained Pipeline
  Smoke-Association-Testing-Pretrained:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Association-Testing-Pretrained
      prerun_cmd: cd ./example && ln -s ../pretrained_models
      pipeline_file: ./pipelines/association_testing_pretrained.snakefile

  Pipeline-Tests-Training-Association-Testing:
    needs: Smoke-Association-Testing-Pretrained
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Pipeline-Tests-Training-Association-Testing
      pipeline_file: ./pipelines/training_association_testing.snakefile
      dry_run: false

  # Association Testing Pretrained Regenie
  Smoke-Association-Testing-Pretrained-Regenie:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Association-Testing-Pretrained-Regenie
      prerun_cmd: cd ./example && ln -s ../pretrained_models
      pipeline_file: ./pipelines/association_testing_pretrained_regenie.snakefile

  Pipeline-Tests-Association-Testing-Pretrained-Regenie:
    needs: Smoke-Association-Testing-Pretrained-Regenie

    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Association-Testing-Pretrained-Regenie
      prerun_cmd: cd ./example && ln -s ../pretrained_models
      pipeline_file: ./pipelines/association_testing_pretrained_regenie.snakefile
      dry_run: false

  # Association Testing Training
  Smoke-Association-Testing-Training:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Association-Testing-Training
      pipeline_file: ./pipelines/training_association_testing.snakefile

  Pipeline-Tests-Association-Testing-Training:
    needs: Smoke-Association-Testing-Training
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Association-Testing-Training
      pipeline_file: ./pipelines/training_association_testing.snakefile
      dry_run: false

  # Association Testing Training Regenie
  Smoke-Association-Testing-Training-Regenie:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Association-Testing-Training-Regenie
      pipeline_file: ./pipelines/training_association_testing_regenie.snakefile

  Pipeline-Tests-Training-Association-Testing-Regenie:
    needs: Smoke-Association-Testing-Training-Regenie
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Association-Testing-Training-Regenie
      pipeline_file: ./pipelines/training_association_testing_regenie.snakefile
      dry_run: false

  # Seed Gene Discovery
  Smoke-Seed-Gene-Discovery:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Seed-Gene-Discovery
      prerun_cmd: cd ./example && cp ../deeprvat/seed_gene_discovery/config.yaml .
      pipeline_file: ./pipelines/seed_gene_discovery.snakefile

  Pipeline-Tests-Seed-Gene-Discovery:
    needs: Smoke-Seed-Gene-Discovery
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Smoke-Seed-Gene-Discovery
      prerun_cmd: cd ./example && cp ../deeprvat/seed_gene_discovery/config.yaml .
      pipeline_file: ./pipelines/seed_gene_discovery.snakefile
      dry_run: false

  # Preprocessing-No-QC
  Smoke-Preprocessing-No-QC:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_preprocessing_env.yml
      name: Smoke-Preprocessing-No-QC
      pipeline_file: ./pipelines/preprocess_no_qc.snakefile

  Pipeline-Tests-Preprocessing-No-QC:
    needs: Smoke-Preprocessing-No-QC
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Pipeline-Tests-Preprocessing-No-QC
      pipeline_file: ./pipelines/preprocess_no_qc.snakefile
      dry_run: false
      download_example_data: true

  # Preprocessing With QC
  Smoke-Preprocessing-With-QC:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_preprocessing_env.yml
      name: Preprocessing-With-QC
      pipeline_file: ./pipelines/preprocess_with_qc.snakefile

  Pipeline-Tests-Preprocessing-With-QC:
    needs: Smoke-Preprocessing-With-QC
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_env_no_gpu.yml
      name: Pipeline-Tests-Preprocessing-No-QC
      pipeline_file: ./pipelines/preprocess_with_qc.snakefile
      dry_run: false
      download_example_data: true

  # Annotation Pipeline
  Smoke-Annotation-Pipeline:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      environment_file: ./deeprvat_preprocessing_env.yml
      name: Preprocessing-With-QC
      pipeline_file: ./pipelines/annotations.snakefile
      pipeline_config: ./pipelines/config/deeprvat_annotation_config.yaml
