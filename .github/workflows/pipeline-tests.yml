name: DeepRVAT Pipeline Tests
run-name: DeepRVAT Pipeline Tests üß¨üß™üíªüßë‚Äçüî¨
on: [ push ]

jobs:
  # Training Pipeline
  Smoke-RunTraining:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/run_training.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      pipeline_config: ./tests/deeprvat/test_data/training/deeprvat_config.yaml

  Pipeline-Tests-RunTraining:
    needs: Smoke-RunTraining
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/run_training.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      pipeline_config: ./tests/deeprvat/test_data/training/deeprvat_config.yaml
      dry_run: false

  # Association Testing Pretrained Pipeline
  Smoke-Association-Testing-Pretrained:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/association_testing_pretrained.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      prerun_cmd: cd ./example && ln -s ../pretrained_models
      pipeline_config: ./tests/deeprvat/pretrained/deeprvat_config.yaml

  Pipeline-Tests-Training-Association-Testing:
    needs: Smoke-Association-Testing-Pretrained
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/association_testing_pretrained.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      prerun_cmd: cd ./example && ln -s ../pretrained_models
      pipeline_config: ./tests/deeprvat/pretrained/deeprvat_config.yaml
      dry_run: false

  # Association Testing Pretrained Regenie
  Smoke-Association-Testing-Pretrained-Regenie:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/association_testing_pretrained_regenie.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      prerun_cmd: cd ./example && ln -s ../pretrained_models
      pipeline_config: ./tests/deeprvat/regenie/pretrained/deeprvat_config.yaml

  Pipeline-Tests-Association-Testing-Pretrained-Regenie:
    needs: Smoke-Association-Testing-Pretrained-Regenie
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/association_testing_pretrained_regenie.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      prerun_cmd: cd ./example && ln -s ../pretrained_models
      pipeline_config: ./tests/deeprvat/regenie/pretrained/deeprvat_config.yaml
      dry_run: false

  # Association Testing Training
  Smoke-Association-Testing-Training:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/training_association_testing.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      pipeline_config: ./tests/deeprvat/test_data/training/deeprvat_config.yaml

  Pipeline-Tests-Association-Testing-Training:
    needs: Smoke-Association-Testing-Training
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/training_association_testing.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      pipeline_config: ./tests/deeprvat/test_data/training/deeprvat_config.yaml
      dry_run: false

  # Association Testing Training Regenie
  Smoke-Association-Testing-Training-Regenie:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/training_association_testing_regenie.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      pipeline_config: ./tests/deeprvat/regenie/training_association_testing/deeprvat_config.yaml

  Pipeline-Tests-Training-Association-Testing-Regenie:
    needs: Smoke-Association-Testing-Training-Regenie
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/training_association_testing_regenie.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      pipeline_config: ./tests/deeprvat/regenie/training_association_testing/deeprvat_config.yaml
      dry_run: false

  # Seed Gene Discovery
  Smoke-Seed-Gene-Discovery:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/seed_gene_discovery.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      prerun_cmd: cd ./example
      pipeline_config: ./tests/seed_gene_discovery/sg_discovery_config.yaml

  Pipeline-Tests-Seed-Gene-Discovery:
    needs: Smoke-Seed-Gene-Discovery
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/seed_gene_discovery.snakefile
      environment_file: ./deeprvat_env_no_gpu.yml
      prerun_cmd: cd ./example
      pipeline_config: ./tests/seed_gene_discovery/sg_discovery_config.yaml
      dry_run: false
      

  # Preprocessing With QC
  Smoke-Preprocessing-With-QC:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/preprocess_with_qc.snakefile
      environment_file: ./deeprvat_preprocessing_env.yml
      pipeline_directory: ./example/preprocess
      pipeline_config: ./example/config/deeprvat_preprocess_config.yaml
      download_fasta_data: true
      fasta_download_path: ./example/preprocess/workdir/reference

  Pipeline-Tests-Preprocessing-With-QC:
    needs: Smoke-Preprocessing-With-QC
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/preprocess_with_qc.snakefile
      environment_file: ./deeprvat_preprocessing_env.yml
      pipeline_directory: ./example/preprocess
      pipeline_config: ./example/config/deeprvat_preprocess_config.yaml
      dry_run: false
      download_fasta_data: true
      fasta_download_path: ./example/preprocess/workdir/reference

  # Preprocessing-No-QC
  Smoke-Preprocessing-No-QC:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/preprocess_no_qc.snakefile
      environment_file: ./deeprvat_preprocessing_env.yml
      pipeline_directory: ./example/preprocess
      pipeline_config: ./example/config/deeprvat_preprocess_config.yaml
      download_fasta_data: true
      fasta_download_path: ./example/preprocess/workdir/reference

  Pipeline-Tests-Preprocessing-No-QC:
    needs: Smoke-Preprocessing-No-QC
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/preprocess_no_qc.snakefile
      environment_file: ./deeprvat_preprocessing_env.yml
      pipeline_directory: ./example/preprocess
      pipeline_config: ./example/config/deeprvat_preprocess_config.yaml
      dry_run: false
      download_fasta_data: true
      fasta_download_path: ./example/preprocess/workdir/reference

  # Annotation Pipeline
  Smoke-Annotation-Pipeline:
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/annotations.snakefile
      environment_file: ./deeprvat_annotations.yml
      pipeline_config: ./example/config/deeprvat_annotation_config.yaml
      pipeline_directory: ./example/annotations
      download_fasta_data: true
      fasta_download_path: ./example/annotations/reference

  Pipeline-Annotation:
    needs: Smoke-Annotation-Pipeline
    uses: ./.github/workflows/run-pipeline.yml
    with:
      pipeline_file: ./pipelines/annotations.snakefile
      environment_file: ./deeprvat_annotations.yml
      prerun_cmd: |
        mkdir ./example/annotations/repo_dir && \
        bash deeprvat/annotations/setup_annotation_workflow.sh ./example/annotations/repo_dir faatpipe && \
        wget https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_44/gencode.v44.annotation.gtf.gz \
        -O ./example/annotations/reference/gencode.v44.annotation.gtf.gz
      pipeline_directory: ./example/annotations
      pipeline_config: ./example/config/deeprvat_annotation_config_minimal.yaml
      dry_run: false
      download_fasta_data: true
      fasta_download_path: ./example/annotations/reference