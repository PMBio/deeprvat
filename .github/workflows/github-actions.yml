name: DeepRVAT
run-name: DeepRVAT üß¨üß™üíªüßë‚Äçüî¨
on: [ push ]

env:
  CUDA_VISIBLE_DEVICES: ""

jobs:
  DeepRVAT-Pipeline-Smoke-Tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Training Association Testing smoke test
        uses: snakemake/snakemake-github-action@v1.24.0
        with:
          directory: 'example'
          snakefile: 'pipelines/training_association_testing.snakefile'
          args: '-j 2 -n'
          stagein: 'pip install -e ${{ github.workspace }}'
      - name: Seed Gene Discovery Smoke Test
        uses: snakemake/snakemake-github-action@v1.24.0
        with:
          directory: 'example'
          snakefile: 'pipelines/seed_gene_discovery.snakefile'
          args: '-j 2 -n'
      - name: Link pretrained models
        run: cd ${{ github.workspace }}/example && ln -s ../pretrained_models
      - name: Association Testing Pretrained Smoke Test
        uses: snakemake/snakemake-github-action@v1.24.0
        with:
          directory: 'example'
          snakefile: 'pipelines/association_testing_pretrained.snakefile'
          args: '-j 2 -n'

  DeepRVAT-Pipeline-Tests:
    runs-on: ubuntu-latest
    needs: DeepRVAT-Pipeline-Smoke-Tests
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - uses: mamba-org/setup-micromamba@v1.4.3
        with:
          environment-name: deeprvat-gh-action
          environment-file: ${{ github.workspace }}/deeprvat_env_no_gpu.yml
          cache-environment: true
          cache-downloads: true
      - name: Install DeepRVAT
        run: pip install -e ${{ github.workspace }}
        shell: micromamba-shell {0}
      # There are no GPUs on the gh worker, so we disable it in the config
      - name: Update config to use no gpus
        run: "sed -i 's/gpus: 1/gpus: 0/' ${{ github.workspace }}/example/config.yaml"
        shell: bash -el {0}
      - name: Run training_association_testing pipeline
        run: |
          python -m snakemake -j 2 --directory ${{ github.workspace }}/example \
          --snakefile ${{ github.workspace }}/pipelines/training_association_testing.snakefile --show-failed-logs
        shell: micromamba-shell {0}
      - name: Link pretrained models
        run: cd ${{ github.workspace }}/example && ln -s ../pretrained_models
        shell: bash -el {0}
      - name: Run association_testing_pretrained pipeline
        run: |
          python -m snakemake -j 2 --directory ${{ github.workspace }}/example \
          --snakefile ${{ github.workspace }}/pipelines/association_testing_pretrained.snakefile --show-failed-logs
        shell: micromamba-shell {0}
